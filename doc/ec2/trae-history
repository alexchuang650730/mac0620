#!/usr/bin/env python3
"""
Trae History Extractor (æŒ‡ä»¤1)
å¾Traeæå–å°è©±æ­·å²ä¸¦ä¿å­˜åˆ°æŒ‡å®šå€‰åº«ç›®éŒ„

ç”¨æ³•: trae-history <å€‰åº«åç¨±> [é¸é …]
"""

import os
import sys
import json
import sqlite3
import subprocess
import argparse
from datetime import datetime
from pathlib import Path

class TraeHistoryExtractor:
    def __init__(self):
        self.ssh_config = {
            "host": "serveo.net",
            "port": 41269,
            "user": "alexchuang",
            "password": "123456"
        }
        self.trae_db_path = "/Users/alexchuang/Library/Application Support/Trae/User/workspaceStorage/f002a9b85f221075092022809f5a075f/state.vscdb"
        self.base_dir = "/home/alexchuang/aiengine/trae/git"
    
    def ssh_execute(self, command):
        """é€šéSSHåŸ·è¡Œå‘½ä»¤"""
        try:
            ssh_cmd = [
                "sshpass", "-p", self.ssh_config["password"],
                "ssh", "-o", "StrictHostKeyChecking=no",
                "-p", str(self.ssh_config["port"]),
                f"{self.ssh_config['user']}@{self.ssh_config['host']}",
                command
            ]
            
            result = subprocess.run(ssh_cmd, capture_output=True, text=True, timeout=30)
            return result.returncode == 0, result.stdout, result.stderr
            
        except Exception as e:
            return False, "", str(e)
    
    def extract_conversation_history(self, repo_name):
        """æå–æŒ‡å®šå€‰åº«çš„å°è©±æ­·å²"""
        print(f"ğŸ” æ­£åœ¨æå–å€‰åº« '{repo_name}' çš„å°è©±æ­·å²...")
        
        # SQLæŸ¥è©¢å‘½ä»¤
        sql_query = f"""
        sqlite3 "{self.trae_db_path}" "
        SELECT key, value FROM ItemTable 
        WHERE key LIKE '%input-history%' OR key LIKE '%memento%'
        ORDER BY key;
        "
        """
        
        success, output, error = self.ssh_execute(sql_query)
        
        if not success:
            print(f"âŒ ç„¡æ³•é€£æ¥åˆ°Traeæ•¸æ“šåº«: {error}")
            return None
        
        # è§£ææ•¸æ“šåº«è¼¸å‡º
        conversations = []
        lines = output.strip().split('\n')
        
        for line in lines:
            if '|' in line:
                key, value = line.split('|', 1)
                try:
                    data = json.loads(value)
                    if isinstance(data, list):
                        for item in data:
                            if isinstance(item, dict) and 'inputText' in item:
                                # æª¢æŸ¥æ˜¯å¦èˆ‡å€‰åº«ç›¸é—œ
                                input_text = item.get('inputText', '').lower()
                                if repo_name.lower() in input_text or any(keyword in input_text for keyword in ['git', 'code', 'project']):
                                    conversations.append({
                                        'timestamp': item.get('timestamp', ''),
                                        'input': item.get('inputText', ''),
                                        'parsed_query': item.get('parsedQuery', []),
                                        'multimedia': item.get('multiMedia', []),
                                        'source': 'input_history'
                                    })
                    elif isinstance(data, dict) and 'content' in data:
                        # å®Œæ•´å°è©±è¨˜éŒ„
                        content = data.get('content', '').lower()
                        if repo_name.lower() in content:
                            conversations.append({
                                'timestamp': data.get('timestamp', ''),
                                'role': data.get('role', ''),
                                'content': data.get('content', ''),
                                'model': data.get('display_model_name', ''),
                                'status': data.get('status', ''),
                                'source': 'conversation'
                            })
                except json.JSONDecodeError:
                    continue
        
        return conversations
    
    def save_history(self, repo_name, conversations):
        """ä¿å­˜å°è©±æ­·å²åˆ°æŒ‡å®šç›®éŒ„"""
        if not conversations:
            print(f"âš ï¸ æœªæ‰¾åˆ°å€‰åº« '{repo_name}' çš„ç›¸é—œå°è©±æ­·å²")
            return False
        
        # å‰µå»ºç›®æ¨™ç›®éŒ„
        history_dir = Path(self.base_dir) / repo_name / "history"
        history_dir.mkdir(parents=True, exist_ok=True)
        
        # ç”Ÿæˆæ–‡ä»¶å
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        history_file = history_dir / f"conversation_history_{timestamp}.json"
        
        # ä¿å­˜æ•¸æ“š
        history_data = {
            "repository": repo_name,
            "extraction_time": datetime.now().isoformat(),
            "total_conversations": len(conversations),
            "conversations": conversations
        }
        
        try:
            with open(history_file, 'w', encoding='utf-8') as f:
                json.dump(history_data, f, indent=2, ensure_ascii=False)
            
            print(f"âœ… å°è©±æ­·å²å·²ä¿å­˜: {history_file}")
            print(f"ğŸ“Š å…±æå– {len(conversations)} æ¢å°è©±è¨˜éŒ„")
            
            # å‰µå»ºæœ€æ–°éˆæ¥
            latest_link = history_dir / "latest.json"
            if latest_link.exists():
                latest_link.unlink()
            latest_link.symlink_to(history_file.name)
            
            return True
            
        except Exception as e:
            print(f"âŒ ä¿å­˜å°è©±æ­·å²å¤±æ•—: {e}")
            return False
    
    def list_repositories(self):
        """åˆ—å‡ºå¯ç”¨çš„å€‰åº«"""
        git_dir = Path(self.base_dir)
        if not git_dir.exists():
            print(f"âŒ Gitç›®éŒ„ä¸å­˜åœ¨: {git_dir}")
            return []
        
        repos = [d.name for d in git_dir.iterdir() if d.is_dir() and (d / ".git").exists()]
        return repos
    
    def extract_history(self, repo_name):
        """åŸ·è¡Œå°è©±æ­·å²æå–"""
        print(f"ğŸš€ é–‹å§‹æå–å€‰åº« '{repo_name}' çš„å°è©±æ­·å²")
        print("=" * 50)
        
        # æª¢æŸ¥å€‰åº«æ˜¯å¦å­˜åœ¨
        repo_path = Path(self.base_dir) / repo_name
        if not repo_path.exists():
            print(f"âŒ å€‰åº«ç›®éŒ„ä¸å­˜åœ¨: {repo_path}")
            return False
        
        # æå–å°è©±æ­·å²
        conversations = self.extract_conversation_history(repo_name)
        if conversations is None:
            return False
        
        # ä¿å­˜æ­·å²è¨˜éŒ„
        return self.save_history(repo_name, conversations)

def main():
    parser = argparse.ArgumentParser(description="Trae History Extractor")
    parser.add_argument("repo_name", nargs="?", help="å€‰åº«åç¨±")
    parser.add_argument("--list", "-l", action="store_true", help="åˆ—å‡ºå¯ç”¨å€‰åº«")
    parser.add_argument("--all", "-a", action="store_true", help="æå–æ‰€æœ‰å€‰åº«çš„æ­·å²")
    
    args = parser.parse_args()
    
    extractor = TraeHistoryExtractor()
    
    if args.list:
        repos = extractor.list_repositories()
        print("ğŸ“‹ å¯ç”¨å€‰åº«:")
        for repo in repos:
            print(f"   ğŸ“ {repo}")
        return
    
    if args.all:
        repos = extractor.list_repositories()
        success_count = 0
        for repo in repos:
            if extractor.extract_history(repo):
                success_count += 1
        print(f"\nğŸ‰ å®Œæˆ! æˆåŠŸæå– {success_count}/{len(repos)} å€‹å€‰åº«çš„æ­·å²")
        return
    
    if not args.repo_name:
        print("âŒ è«‹æŒ‡å®šå€‰åº«åç¨±æˆ–ä½¿ç”¨ --list æŸ¥çœ‹å¯ç”¨å€‰åº«")
        parser.print_help()
        return
    
    # æå–æŒ‡å®šå€‰åº«çš„æ­·å²
    success = extractor.extract_history(args.repo_name)
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()


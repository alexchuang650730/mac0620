#!/usr/bin/env python3
"""
Trae Repository Sync (æŒ‡ä»¤2)
æ‰¾åˆ°å€‰åº«åç¨±ä¸¦åŒæ­¥æºç¢¼åˆ°æŒ‡å®šç›®éŒ„

ç”¨æ³•: trae-sync <å€‰åº«åç¨±> [é¸é …]
"""

import os
import sys
import json
import subprocess
import argparse
from datetime import datetime
from pathlib import Path

class TraeRepositorySync:
    def __init__(self):
        self.ssh_config = {
            "host": "serveo.net", 
            "port": 41269,
            "user": "alexchuang",
            "password": "123456"
        }
        self.github_username = "alexchuang650730"
        self.base_dir = "/home/alexchuang/aiengine/trae/git"
        self.trae_app_support = "/Users/alexchuang/Library/Application Support/Trae"
    
    def ssh_execute(self, command):
        """é€šéSSHåŸ·è¡Œå‘½ä»¤"""
        try:
            ssh_cmd = [
                "sshpass", "-p", self.ssh_config["password"],
                "ssh", "-o", "StrictHostKeyChecking=no",
                "-p", str(self.ssh_config["port"]),
                f"{self.ssh_config['user']}@{self.ssh_config['host']}",
                command
            ]
            
            result = subprocess.run(ssh_cmd, capture_output=True, text=True, timeout=60)
            return result.returncode == 0, result.stdout, result.stderr
            
        except Exception as e:
            return False, "", str(e)
    
    def discover_repositories(self):
        """å¾Traeä¸­ç™¼ç¾å€‰åº«åˆ—è¡¨"""
        print("ğŸ” æ­£åœ¨å¾Traeä¸­ç™¼ç¾å€‰åº«...")
        
        # æœç´¢CodeKGæ•¸æ“šåº«
        ckg_command = f'find "{self.trae_app_support}/User/globalStorage/.ckg/storage" -name "*_codekg.db" 2>/dev/null | head -20'
        success, output, error = self.ssh_execute(ckg_command)
        
        repositories = set()
        
        if success and output:
            for line in output.strip().split('\n'):
                if line and '_codekg.db' in line:
                    repo_name = Path(line).stem.replace('_codekg', '')
                    if repo_name and repo_name not in ['Shared', 'temp']:
                        repositories.add(repo_name)
        
        # æ·»åŠ å·²çŸ¥å€‰åº«
        known_repos = [
            "powerauto.ai_0.53",
            "communitypowerautomation",
            "powerauto_v0.3", 
            "powerautomation",
            "final_integration_fixed",
            "communitypowerauto"
        ]
        
        repositories.update(known_repos)
        
        print(f"ğŸ“¦ ç™¼ç¾ {len(repositories)} å€‹å€‰åº«")
        return list(repositories)
    
    def sync_repository_source(self, repo_name):
        """åŒæ­¥å€‰åº«æºç¢¼"""
        print(f"ğŸ”„ æ­£åœ¨åŒæ­¥å€‰åº« '{repo_name}' çš„æºç¢¼...")
        
        # å‰µå»ºæºç¢¼ç›®éŒ„
        source_dir = Path(self.base_dir) / repo_name / "source"
        source_dir.mkdir(parents=True, exist_ok=True)
        
        # Gitå€‰åº«URL
        repo_url = f"https://github.com/{self.github_username}/{repo_name}.git"
        
        # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨Gitå€‰åº«
        git_dir = Path(self.base_dir) / repo_name
        
        try:
            if (git_dir / ".git").exists():
                # æ›´æ–°ç¾æœ‰å€‰åº«
                print(f"ğŸ“¥ æ›´æ–°ç¾æœ‰å€‰åº«: {repo_name}")
                result = subprocess.run([
                    "git", "-C", str(git_dir), "pull", "origin", "main"
                ], capture_output=True, text=True, timeout=120)
                
                if result.returncode != 0:
                    # å˜—è©¦masteråˆ†æ”¯
                    result = subprocess.run([
                        "git", "-C", str(git_dir), "pull", "origin", "master"
                    ], capture_output=True, text=True, timeout=120)
                
                if result.returncode != 0:
                    print(f"âš ï¸ Git pullå¤±æ•—ï¼Œå˜—è©¦é‡æ–°å…‹éš†...")
                    subprocess.run(["rm", "-rf", str(git_dir)], capture_output=True)
                    return self.clone_repository(repo_name, repo_url)
            else:
                # å…‹éš†æ–°å€‰åº«
                return self.clone_repository(repo_name, repo_url)
            
            # è¤‡è£½æºç¢¼åˆ°sourceç›®éŒ„
            self.copy_source_files(git_dir, source_dir)
            
            print(f"âœ… å€‰åº« '{repo_name}' æºç¢¼åŒæ­¥å®Œæˆ")
            return True
            
        except Exception as e:
            print(f"âŒ åŒæ­¥å€‰åº« '{repo_name}' å¤±æ•—: {e}")
            return False
    
    def clone_repository(self, repo_name, repo_url):
        """å…‹éš†å€‰åº«"""
        print(f"ğŸ“¥ å…‹éš†å€‰åº«: {repo_name}")
        
        git_dir = Path(self.base_dir) / repo_name
        
        result = subprocess.run([
            "git", "clone", repo_url, str(git_dir)
        ], capture_output=True, text=True, timeout=300)
        
        if result.returncode == 0:
            source_dir = git_dir / "source"
            self.copy_source_files(git_dir, source_dir)
            return True
        else:
            print(f"âŒ å…‹éš†å¤±æ•—: {result.stderr}")
            return False
    
    def copy_source_files(self, git_dir, source_dir):
        """è¤‡è£½æºç¢¼æ–‡ä»¶åˆ°sourceç›®éŒ„"""
        try:
            # æ¸…ç©ºsourceç›®éŒ„
            if source_dir.exists():
                subprocess.run(["rm", "-rf", str(source_dir)], capture_output=True)
            source_dir.mkdir(parents=True, exist_ok=True)
            
            # è¤‡è£½æ‰€æœ‰æ–‡ä»¶ï¼Œæ’é™¤.gitç›®éŒ„
            for item in git_dir.iterdir():
                if item.name != ".git" and item.name != "source":
                    if item.is_dir():
                        subprocess.run([
                            "cp", "-r", str(item), str(source_dir / item.name)
                        ], capture_output=True)
                    else:
                        subprocess.run([
                            "cp", str(item), str(source_dir / item.name)
                        ], capture_output=True)
            
            # å‰µå»ºåŒæ­¥ä¿¡æ¯æ–‡ä»¶
            sync_info = {
                "repository": git_dir.name,
                "sync_time": datetime.now().isoformat(),
                "source_directory": str(source_dir),
                "git_directory": str(git_dir)
            }
            
            with open(source_dir / "sync_info.json", 'w', encoding='utf-8') as f:
                json.dump(sync_info, f, indent=2, ensure_ascii=False)
            
            print(f"ğŸ“ æºç¢¼å·²è¤‡è£½åˆ°: {source_dir}")
            
        except Exception as e:
            print(f"âš ï¸ è¤‡è£½æºç¢¼æ™‚å‡ºç¾è­¦å‘Š: {e}")
    
    def list_repositories(self):
        """åˆ—å‡ºå¯ç”¨å€‰åº«"""
        git_dir = Path(self.base_dir)
        if not git_dir.exists():
            return []
        
        repos = [d.name for d in git_dir.iterdir() if d.is_dir()]
        return repos
    
    def sync_repository(self, repo_name):
        """åŸ·è¡Œå€‰åº«åŒæ­¥"""
        print(f"ğŸš€ é–‹å§‹åŒæ­¥å€‰åº« '{repo_name}'")
        print("=" * 50)
        
        return self.sync_repository_source(repo_name)

def main():
    parser = argparse.ArgumentParser(description="Trae Repository Sync")
    parser.add_argument("repo_name", nargs="?", help="å€‰åº«åç¨±")
    parser.add_argument("--list", "-l", action="store_true", help="åˆ—å‡ºå¯ç”¨å€‰åº«")
    parser.add_argument("--discover", "-d", action="store_true", help="å¾Traeç™¼ç¾å€‰åº«")
    parser.add_argument("--all", "-a", action="store_true", help="åŒæ­¥æ‰€æœ‰å€‰åº«")
    
    args = parser.parse_args()
    
    syncer = TraeRepositorySync()
    
    if args.list:
        repos = syncer.list_repositories()
        print("ğŸ“‹ æœ¬åœ°å€‰åº«:")
        for repo in repos:
            print(f"   ğŸ“ {repo}")
        return
    
    if args.discover:
        repos = syncer.discover_repositories()
        print("ğŸ“‹ ç™¼ç¾çš„å€‰åº«:")
        for repo in repos:
            print(f"   ğŸ“ {repo}")
        return
    
    if args.all:
        repos = syncer.discover_repositories()
        success_count = 0
        for repo in repos:
            if syncer.sync_repository(repo):
                success_count += 1
        print(f"\nğŸ‰ å®Œæˆ! æˆåŠŸåŒæ­¥ {success_count}/{len(repos)} å€‹å€‰åº«")
        return
    
    if not args.repo_name:
        print("âŒ è«‹æŒ‡å®šå€‰åº«åç¨±æˆ–ä½¿ç”¨ --list æŸ¥çœ‹å¯ç”¨å€‰åº«")
        parser.print_help()
        return
    
    # åŒæ­¥æŒ‡å®šå€‰åº«
    success = syncer.sync_repository(args.repo_name)
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()


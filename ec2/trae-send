#!/usr/bin/env python3
"""
Trae Message Sender (æŒ‡ä»¤3)
å‘Traeå°è©±æ¡†ç™¼é€æ¶ˆæ¯ä¸¦ç¢ºèªè¨˜éŒ„åˆ°å°è©±æ­·å²

ç”¨æ³•: trae-send <å€‰åº«åç¨±> <æ¶ˆæ¯å…§å®¹> [é¸é …]
"""

import os
import sys
import json
import sqlite3
import subprocess
import argparse
import time
from datetime import datetime
from pathlib import Path

class TraeMessageSender:
    def __init__(self):
        self.ssh_config = {
            "host": "serveo.net",
            "port": 41269, 
            "user": "alexchuang",
            "password": "123456"
        }
        self.trae_db_path = "/Users/alexchuang/Library/Application Support/Trae/User/workspaceStorage/f002a9b85f221075092022809f5a075f/state.vscdb"
        self.base_dir = "/home/alexchuang/aiengine/trae/git"
    
    def ssh_execute(self, command):
        """é€šéSSHåŸ·è¡Œå‘½ä»¤"""
        try:
            ssh_cmd = [
                "sshpass", "-p", self.ssh_config["password"],
                "ssh", "-o", "StrictHostKeyChecking=no",
                "-p", str(self.ssh_config["port"]),
                f"{self.ssh_config['user']}@{self.ssh_config['host']}",
                command
            ]
            
            result = subprocess.run(ssh_cmd, capture_output=True, text=True, timeout=30)
            return result.returncode == 0, result.stdout, result.stderr
            
        except Exception as e:
            return False, "", str(e)
    
    def get_conversation_count_before(self):
        """ç²å–ç™¼é€æ¶ˆæ¯å‰çš„å°è©±æ•¸é‡"""
        sql_query = f'''
        sqlite3 "{self.trae_db_path}" "
        SELECT COUNT(*) FROM ItemTable 
        WHERE key LIKE '%input-history%' OR key LIKE '%memento%';
        "
        '''
        
        success, output, error = self.ssh_execute(sql_query)
        if success and output.strip().isdigit():
            return int(output.strip())
        return 0
    
    def send_message_to_trae(self, repo_name, message):
        """å‘Traeç™¼é€æ¶ˆæ¯"""
        print(f"ğŸ“¤ æ­£åœ¨å‘å€‰åº« '{repo_name}' ç™¼é€æ¶ˆæ¯...")
        print(f"ğŸ’¬ æ¶ˆæ¯å…§å®¹: {message}")
        
        # ç²å–ç™¼é€å‰çš„å°è©±æ•¸é‡
        count_before = self.get_conversation_count_before()
        print(f"ğŸ“Š ç™¼é€å‰å°è©±è¨˜éŒ„æ•¸: {count_before}")
        
        # æ§‹é€ ç™¼é€æ¶ˆæ¯çš„å‘½ä»¤
        # é€™è£¡ä½¿ç”¨AppleScriptä¾†æ“ä½œTraeæ‡‰ç”¨
        applescript = f'''
        tell application "Trae"
            activate
            delay 1
            
            -- å˜—è©¦æ‰¾åˆ°è¼¸å…¥æ¡†ä¸¦ç™¼é€æ¶ˆæ¯
            tell application "System Events"
                -- ç­‰å¾…æ‡‰ç”¨åŠ è¼‰
                delay 2
                
                -- æŸ¥æ‰¾è¼¸å…¥æ¡† (å¯èƒ½éœ€è¦æ ¹æ“šå¯¦éš›UIèª¿æ•´)
                try
                    -- æ–¹æ³•1: ç›´æ¥è¼¸å…¥æ–‡æœ¬
                    keystroke "{message}"
                    delay 1
                    keystroke return
                    
                    -- æˆ–è€…æ–¹æ³•2: ä½¿ç”¨UIå…ƒç´ 
                    -- click text field 1 of window 1 of application process "Trae"
                    -- keystroke "{message}"
                    -- keystroke return
                on error
                    -- å¦‚æœç›´æ¥è¼¸å…¥å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–æ–¹æ³•
                    key code 36 -- Enter key
                end try
            end tell
        end tell
        '''
        
        # å°‡AppleScriptä¿å­˜åˆ°è‡¨æ™‚æ–‡ä»¶
        script_file = "/tmp/trae_send_message.scpt"
        applescript_command = f'''
        cat > {script_file} << 'EOF'
{applescript}
EOF
        '''
        
        success, output, error = self.ssh_execute(applescript_command)
        if not success:
            print(f"âŒ å‰µå»ºAppleScriptå¤±æ•—: {error}")
            return False
        
        # åŸ·è¡ŒAppleScript
        execute_command = f"osascript {script_file}"
        success, output, error = self.ssh_execute(execute_command)
        
        if not success:
            print(f"âŒ åŸ·è¡ŒAppleScriptå¤±æ•—: {error}")
            # å˜—è©¦å‚™ç”¨æ–¹æ³•ï¼šç›´æ¥æ“ä½œå‰ªè²¼æ¿
            return self.send_via_clipboard(message)
        
        print("âœ… æ¶ˆæ¯å·²ç™¼é€åˆ°Trae")
        return True
    
    def send_via_clipboard(self, message):
        """é€šéå‰ªè²¼æ¿ç™¼é€æ¶ˆæ¯çš„å‚™ç”¨æ–¹æ³•"""
        print("ğŸ”„ å˜—è©¦é€šéå‰ªè²¼æ¿ç™¼é€æ¶ˆæ¯...")
        
        clipboard_script = f'''
        echo "{message}" | pbcopy
        
        osascript -e '
        tell application "Trae"
            activate
        end tell
        
        tell application "System Events"
            delay 2
            keystroke "v" using command down
            delay 1
            keystroke return
        end tell
        '
        '''
        
        success, output, error = self.ssh_execute(clipboard_script)
        
        if success:
            print("âœ… æ¶ˆæ¯å·²é€šéå‰ªè²¼æ¿ç™¼é€")
            return True
        else:
            print(f"âŒ å‰ªè²¼æ¿ç™¼é€å¤±æ•—: {error}")
            return False
    
    def verify_message_recorded(self, repo_name, message, count_before, max_wait=30):
        """é©—è­‰æ¶ˆæ¯æ˜¯å¦å·²è¨˜éŒ„åˆ°å°è©±æ­·å²"""
        print("ğŸ” æ­£åœ¨é©—è­‰æ¶ˆæ¯æ˜¯å¦å·²è¨˜éŒ„...")
        
        start_time = time.time()
        
        while time.time() - start_time < max_wait:
            # æª¢æŸ¥å°è©±è¨˜éŒ„æ•¸é‡æ˜¯å¦å¢åŠ 
            count_after = self.get_conversation_count_before()
            
            if count_after > count_before:
                print(f"ğŸ“Š ç™¼é€å¾Œå°è©±è¨˜éŒ„æ•¸: {count_after}")
                
                # æŸ¥è©¢æœ€æ–°çš„å°è©±è¨˜éŒ„
                sql_query = f'''
                sqlite3 "{self.trae_db_path}" "
                SELECT value FROM ItemTable 
                WHERE key LIKE '%input-history%' OR key LIKE '%memento%'
                ORDER BY rowid DESC LIMIT 5;
                "
                '''
                
                success, output, error = self.ssh_execute(sql_query)
                
                if success:
                    # æª¢æŸ¥æ˜¯å¦åŒ…å«æˆ‘å€‘ç™¼é€çš„æ¶ˆæ¯
                    if message.lower() in output.lower():
                        print("âœ… æ¶ˆæ¯å·²æˆåŠŸè¨˜éŒ„åˆ°å°è©±æ­·å²")
                        return True
            
            time.sleep(2)
        
        print("âš ï¸ ç„¡æ³•ç¢ºèªæ¶ˆæ¯æ˜¯å¦å·²è¨˜éŒ„ï¼Œå¯èƒ½éœ€è¦æ‰‹å‹•æª¢æŸ¥")
        return False
    
    def save_send_log(self, repo_name, message, success, verification_result):
        """ä¿å­˜ç™¼é€æ—¥èªŒ"""
        log_dir = Path(self.base_dir) / repo_name / "history"
        log_dir.mkdir(parents=True, exist_ok=True)
        
        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "repository": repo_name,
            "message": message,
            "send_success": success,
            "verification_success": verification_result,
            "action": "message_sent"
        }
        
        # ä¿å­˜åˆ°ç™¼é€æ—¥èªŒæ–‡ä»¶
        log_file = log_dir / "send_log.jsonl"
        
        try:
            with open(log_file, 'a', encoding='utf-8') as f:
                f.write(json.dumps(log_entry, ensure_ascii=False) + '\n')
            
            print(f"ğŸ“ ç™¼é€æ—¥èªŒå·²ä¿å­˜: {log_file}")
            
        except Exception as e:
            print(f"âš ï¸ ä¿å­˜ç™¼é€æ—¥èªŒå¤±æ•—: {e}")
    
    def send_message(self, repo_name, message):
        """åŸ·è¡Œæ¶ˆæ¯ç™¼é€æµç¨‹"""
        print(f"ğŸš€ é–‹å§‹å‘å€‰åº« '{repo_name}' ç™¼é€æ¶ˆæ¯")
        print("=" * 50)
        
        # æª¢æŸ¥å€‰åº«æ˜¯å¦å­˜åœ¨
        repo_path = Path(self.base_dir) / repo_name
        if not repo_path.exists():
            print(f"âŒ å€‰åº«ç›®éŒ„ä¸å­˜åœ¨: {repo_path}")
            return False
        
        # ç²å–ç™¼é€å‰çš„å°è©±æ•¸é‡
        count_before = self.get_conversation_count_before()
        
        # ç™¼é€æ¶ˆæ¯
        send_success = self.send_message_to_trae(repo_name, message)
        
        if not send_success:
            print("âŒ æ¶ˆæ¯ç™¼é€å¤±æ•—")
            self.save_send_log(repo_name, message, False, False)
            return False
        
        # ç­‰å¾…ä¸¦é©—è­‰æ¶ˆæ¯è¨˜éŒ„
        verification_result = self.verify_message_recorded(repo_name, message, count_before)
        
        # ä¿å­˜ç™¼é€æ—¥èªŒ
        self.save_send_log(repo_name, message, send_success, verification_result)
        
        if verification_result:
            print("ğŸ‰ æ¶ˆæ¯ç™¼é€ä¸¦è¨˜éŒ„æˆåŠŸ!")
        else:
            print("âš ï¸ æ¶ˆæ¯å·²ç™¼é€ï¼Œä½†ç„¡æ³•ç¢ºèªè¨˜éŒ„ç‹€æ…‹")
        
        return send_success
    
    def list_repositories(self):
        """åˆ—å‡ºå¯ç”¨å€‰åº«"""
        git_dir = Path(self.base_dir)
        if not git_dir.exists():
            return []
        
        repos = [d.name for d in git_dir.iterdir() if d.is_dir()]
        return repos

def main():
    parser = argparse.ArgumentParser(description="Trae Message Sender")
    parser.add_argument("repo_name", nargs="?", help="å€‰åº«åç¨±")
    parser.add_argument("message", nargs="?", help="è¦ç™¼é€çš„æ¶ˆæ¯")
    parser.add_argument("--list", "-l", action="store_true", help="åˆ—å‡ºå¯ç”¨å€‰åº«")
    parser.add_argument("--test", "-t", action="store_true", help="ç™¼é€æ¸¬è©¦æ¶ˆæ¯")
    
    args = parser.parse_args()
    
    sender = TraeMessageSender()
    
    if args.list:
        repos = sender.list_repositories()
        print("ğŸ“‹ å¯ç”¨å€‰åº«:")
        for repo in repos:
            print(f"   ğŸ“ {repo}")
        return
    
    if args.test:
        if not args.repo_name:
            print("âŒ æ¸¬è©¦æ¨¡å¼éœ€è¦æŒ‡å®šå€‰åº«åç¨±")
            return
        
        test_message = f"æ¸¬è©¦æ¶ˆæ¯ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        success = sender.send_message(args.repo_name, test_message)
        sys.exit(0 if success else 1)
    
    if not args.repo_name or not args.message:
        print("âŒ è«‹æŒ‡å®šå€‰åº«åç¨±å’Œæ¶ˆæ¯å…§å®¹")
        parser.print_help()
        return
    
    # ç™¼é€æŒ‡å®šæ¶ˆæ¯
    success = sender.send_message(args.repo_name, args.message)
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()

